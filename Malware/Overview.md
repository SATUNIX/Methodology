# **Advanced Malware Development & Evasion**

## **Scenario:**
This document provides an **advanced methodology** for **malware development and evasion** in **highly monitored environments**. The goal is to craft **stealthy payloads, bypass modern AV/EDR solutions, and establish resilient command-and-control (C2) channels** while maintaining operational security.

### **References for Further Study:**
- **MITRE ATT&CK ‚Äì Defense Evasion & Execution Techniques**
- **Offensive Security Exploit Developer Guide**
- **Cobalt Strike, Sliver, and Mythic Documentation**
- **SpecterOps Research on AV/EDR Evasion**
- **Advanced Malware Analysis (Practical Malware Analysis by Sikorski & Honig)**

---

# **üõ† Step 1: Custom Payload Development (T1203, T1204, T1105)**
**Objective:** Create payloads that avoid static and heuristic detection.

### **1.1 C2 Frameworks & Agent Development**
- **Custom Cobalt Strike BOFs** (Beacon Object Files for stealthy in-memory execution)
- **Mythic Agents** (Polyglot implants supporting Python, Go, Rust, and C#)
- **Sliver C2 Payloads** (Cross-platform post-exploitation with encrypted comms)
- **Direct Shellcode Execution** (In-memory loaders via Golang, Nim, or Rust)

### **1.2 Obfuscation & Signature Evasion**
- **Custom Compilers & Build Pipelines** (Modifying GCC/LLVM for unique binaries)
- **Manually Changing PE Headers** (Randomizing timestamps, segment alignments)
- **Junk Code Injection & Control Flow Flattening** (Disrupting AV heuristics)
- **Encrypting Strings & API Calls** (Dynamic API resolution via hashing functions)

---

# **üì° Step 2: Shellcode Obfuscation & Packing (T1027, T1140, T1497)**
**Objective:** Evade detection by using **multiple obfuscation layers** and encryption techniques.

### **2.1 Inline Assembly & Direct Syscalls**
- **SysWhispers & Hell‚Äôs Gate** (Direct syscall execution to bypass user-mode hooks)
- **Inline Assembly Stagers** (Custom shellcode execution without calling APIs directly)
- **Indirect Syscall Execution** (Evading EDR by avoiding NtDLL stubs)

### **2.2 Payload Packing & PE Modification**
- **Using Gargoyle Loader** (Encrypted shellcode that only decrypts in memory)
- **Custom Packers** (Manually XOR, AES, or RC4 encrypt shellcode)
- **Process Hollowing & Doppelg√§nging** (Injecting into legitimate processes)
- **Reflective DLL Injection** (Executing payloads without writing to disk)

---

# **üîë Step 3: AV & EDR Bypasses (T1055, T1202, T1562.001)**
**Objective:** Defeat **modern security solutions** using low-level and user-mode techniques.

### **3.1 Evasion of Memory Scanners**
- **Manually Unhooking EDR Hooks** (Restoring original syscalls via fresh DLL mappings)
- **Sleep Obfuscation & Timing Attacks** (Avoiding sandboxes and memory scanning)
- **APC Injection & Thread Hijacking** (Hiding execution within suspended threads)

### **3.2 Avoiding User-Mode Hooking**
- **Direct Syscalls Instead of WinAPI Calls** (SysWhispers, Inline Assembly)
- **AMSI & ETW Bypass Techniques** (Patching amsi.dll & ETW Tracing hooks)
- **Code Injection via Hardware Breakpoints** (Using debug registers to trigger payloads)

---

# **üì° Step 4: DLL Sideloading & Process Injection (T1574.002, T1055.012, T1547.001)**
**Objective:** Deploy stealthy execution techniques using legitimate binaries.

### **4.1 DLL Sideloading Techniques**
- **Targeting High-Trust Applications** (Windows Defender, Adobe, Microsoft Office)
- **Hijacking DLL Load Order** (Abusing weak search paths in system directories)
- **Embedding Payloads in Signed Binaries** (Modifying dependencies of known executables)

### **4.2 Process Injection Methods**
- **Process Hollowing** (Replacing memory of a legitimate process with shellcode)
- **Atom Bombing & Thread Queue Hijacking** (Manipulating process memory for execution)
- **Reflective PE Injection** (Loading EXEs into memory without touching disk)

---

# **üèÜ Step 5: C2 Evasion & Network Stealth (T1573, T1571, T1090)**
**Objective:** Maintain resilient communication channels while evading network defenses.

### **5.1 Stealthy C2 Communication Methods**
- **Domain Fronting** (Routing C2 traffic through legitimate cloud services like AWS, Azure)
- **Encrypted DNS Tunnels** (Hiding payloads within DNS queries/responses)
- **ICMP & HTTPS Covert Channels** (Using normal-looking network traffic for exfiltration)
- **Using Legitimate Web Services for C2** (Slack, Telegram, GitHub C2 payload staging)

### **5.2 Evading Network Detection & Sandboxes**
- **Mutating Network Traffic Patterns** (Randomized beaconing intervals, encrypted payloads)
- **User-Agent & JA3 Fingerprint Spoofing** (Mimicking legitimate TLS traffic)
- **Packet Fragmentation & Exfiltration over Stealth Channels** (Hiding in normal DNS traffic)
- **DGA (Domain Generation Algorithm) C2s** (Generating ever-changing command domains)

---

# **üõë Step 6: Covering Tracks & Anti-Forensics (T1070, T1564, T1098)**
**Objective:** Erase all forensic traces and maintain stealth after execution.

### **6.1 Log Manipulation & Anti-Forensics**
- **Clearing Windows Event Logs Selectively** (Using API calls instead of brute-force deletion)
- **Tampering with Sysmon & Security Logs** (Modifying timestamps and obfuscating traces)
- **Hiding File Creation & Registry Modifications** (Direct syscall manipulation to bypass logging)

### **6.2 Self-Destructing Payloads & Cleanup Mechanisms**
- **Time-based Payload Execution & Cleanup** (Payloads that auto-delete after execution)
- **Process Masquerading & Code Stomping** (Replacing running code to cover forensic evidence)
- **Injecting into Memory-Only Execution Environments** (No on-disk artifacts, no recoverable traces)

---

# **üìå Summary of Malware Development & Evasion Techniques**

| **Stage** | **Primary Method** | **Alternative Methods** |
|---|---|---|
| **Custom Payloads** | Cobalt Strike BOFs, Sliver, Mythic | Custom loaders in Golang, Nim, Rust |
| **Shellcode Obfuscation** | SysWhispers, Gargoyle Loader | XOR/AES Encryption, Reflective DLLs |
| **AV/EDR Bypass** | Direct Syscalls, AMSI Patching | User-mode hooking evasion, Thread Hijacking |
| **DLL Injection** | Process Hollowing, Reflective PE | Atom Bombing, APC Injection |
| **C2 Evasion** | Domain Fronting, DNS-over-HTTPS | Covert channels over ICMP, JA3 TLS spoofing |
| **Anti-Forensics** | Log Tampering, Memory-Only Execution | Self-Destructing Payloads, Process Masquerading |

