# **Advanced Shellcode Obfuscation & Packing**

## **Scenario:**
This document provides an **in-depth methodology** for **shellcode obfuscation and packing** to evade modern **AV/EDR detection mechanisms**. The goal is to implement **multiple obfuscation layers, encryption techniques, and stealthy execution methods** while maintaining payload execution reliability.

### **References for Further Study:**
- **MITRE ATT&CK â€“ Defense Evasion Techniques (T1027, T1140, T1497)**
- **Advanced Malware Analysis & Obfuscation Techniques**
- **Offensive Securityâ€™s Shellcode Development & AV Evasion Research**
- **Red Team Research on In-Memory Execution & Process Injection**
- **SpecterOps & Endgame Research on Modern EDR Bypasses**

---

# **ðŸ›  Step 2: Shellcode Obfuscation & Packing (T1027, T1140, T1497)**
**Objective:** Evade detection by using **multiple obfuscation layers, encryption techniques, and stealth execution methods**.

## **2.1 Inline Assembly & Direct Syscalls**

### **SysWhispers & Hellâ€™s Gate (Direct Syscall Execution to Bypass User-Mode Hooks)**
- **EDR and AV solutions hook user-mode API functions (NtReadVirtualMemory, NtWriteVirtualMemory).**
- **SysWhispers (SysWhispers2, SysWhispers3) generates custom syscalls to bypass user-mode hooks.**
- **Hellâ€™s Gate abuses function prologues to dynamically resolve syscalls without relying on NtDLL.**
- **Implementation Techniques:**
  - **Extract syscalls from the System Service Descriptor Table (SSDT).**
  - **Manually resolve syscall numbers at runtime (avoid static detection).**
  - **Use indirect execution techniques (JOP chains) to evade syscall monitoring.**
- **Alternative Methods:**
  - **Inline Assembly Stagers for manual shellcode execution (bypassing API monitoring).**
  - **Direct Kernel Object Manipulation (DKOM) for stealthier execution paths.**

### **Inline Assembly Stagers (Custom Shellcode Execution Without API Calls)**
- **Objective:** Execute shellcode without invoking standard APIs (CreateRemoteThread, VirtualAlloc, etc.).
- **Implementation Techniques:**
  - **Write shellcode in assembly using FASM, NASM, or inline assembly in C.**
  - **Use `jmp` and `call` instructions to avoid API lookups.**
  - **Encrypt shellcode with XOR or AES and decrypt at runtime.**
- **EDR Evasion Strategies:**
  - **Avoid stack-based execution (move execution to RWX memory).**
  - **Randomize instruction ordering to avoid signature-based detection.**
  - **Use Register Usage Obfuscation (RSP/RBP swaps) to alter execution flow.**

### **Indirect Syscall Execution (Evading EDR by Avoiding NtDLL Stubs)**
- **Why?** Modern EDR hooks API functions inside `ntdll.dll`. Instead of calling NtOpenProcess, we resolve the function manually and call it via syscalls.
- **Techniques:**
  - **Using direct syscalls with SysWhispers3 (bypasses user-mode hooks).**
  - **Using indirect calls via function pointers (evades static detections).**
  - **Leveraging call stacks from known safe functions (e.g., `KiUserExceptionDispatcher`).**
  - **Stack Spoofing & ROP Gadgets to execute syscalls without triggering user-mode heuristics.**
- **Alternative Methods:**
  - **Hijack trusted Windows processes (e.g., dllhost.exe, svchost.exe) to proxy syscalls.**
  - **Use Heavenâ€™s Gate for executing 64-bit syscalls from a 32-bit process.**

---

## **2.2 Payload Packing & PE Modification**

### **Using Gargoyle Loader (Encrypted Shellcode That Only Decrypts in Memory)**
- **Objective:** Prevent memory scanners from detecting staged shellcode.
- **How It Works:**
  - **Encrypt shellcode using AES, XOR, or custom algorithms.**
  - **Decrypt in a separate memory region just before execution.**
  - **Mark pages as RWX only at runtime (avoid memory-based detections).**
- **EDR Evasion Strategies:**
  - **Polymorphic shellcode encryption (changing opcodes at runtime).**
  - **Self-modifying code to alter execution every time the payload runs.**
  - **Using Stealth Memory Allocations (`NtAllocateVirtualMemory` instead of `VirtualAlloc`).**

### **Custom Packers (Manually XOR, AES, or RC4 Encrypt Shellcode)**
- **Objective:** Modify binary payload structures to break AV signature-based detection.
- **Implementation Techniques:**
  - **Manually encrypt shellcode using XOR, AES, or RC4 (random key per execution).**
  - **Encode payloads using Base64, ROT13, or custom encoding schemes.**
  - **Store shellcode in segments and reconstruct dynamically to evade static analysis.**
- **Alternative Methods:**
  - **Modify the entry point of executables (Random Entry Point Obfuscation).**
  - **Employ thread-stacking techniques to execute shellcode out-of-order.**
  - **Use sandbox detection techniques (delayed execution, API stalling).**

### **Process Hollowing & DoppelgÃ¤nging (Injecting into Legitimate Processes)**
- **Process Hollowing:**
  - **Start a legitimate process in a suspended state.**
  - **Unmap the original process memory and inject malicious code.**
  - **Resume the process with modified memory regions.**
- **DoppelgÃ¤nging (Fileless Process Injection Technique):**
  - **Leverage NTFS Transactional APIs to replace executable images before execution.**
  - **Inject shellcode into memory regions before execution to avoid signature detection.**
  - **Bypass security tools that monitor process creation events.**
- **Alternative Methods:**
  - **Atom Bombing (Using Windows Atom Tables for code injection).**
  - **Early Bird Injection (Executing shellcode before process initialization).**
  - **Phantom DLL Hollowing (Injecting payloads inside legit DLL sections).**

### **Reflective DLL Injection (Executing Payloads Without Writing to Disk)**
- **Objective:** Run DLL payloads in memory to avoid file-based detection.
- **Implementation Techniques:**
  - **Load DLLs reflectively using `LoadLibrary` without writing them to disk.**
  - **Modify process memory using `NtWriteVirtualMemory`.**
  - **Manually resolve imports within the payload to avoid API lookup detection.**
- **Alternative Methods:**
  - **Hijack known processes (explorer.exe, svchost.exe) to execute reflectively.**
  - **Use thread hijacking to inject DLLs into running processes.**
  - **Use APC Queue Injection to execute payloads inside legitimate system processes.**

---

## **ðŸ“Œ Summary of Advanced Shellcode Obfuscation & Packing Techniques**

| **Stage** | **Primary Method** | **Alternative Methods** |
|---|---|---|
| **Syscall Evasion** | SysWhispers, Hellâ€™s Gate | Heavenâ€™s Gate, Indirect Function Resolution |
| **Inline Assembly Execution** | Direct Syscalls | JOP Chains, ROP Gadgets |
| **Payload Encryption** | Gargoyle Loader, AES XOR Encoding | Self-Modifying Code, Stack Pivoting |
| **Process Injection** | Process Hollowing, DoppelgÃ¤nging | Atom Bombing, Phantom DLL Injection |
| **Reflective Execution** | Reflective DLL Injection | PE Injection, Thread Hijacking |
