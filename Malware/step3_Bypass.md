# **AV & EDR Bypasses**

## **Scenario:**
This document outlines advanced **AV & EDR evasion techniques**, enabling **stealthy execution of payloads** while bypassing modern endpoint detection mechanisms. The goal is to exploit weaknesses in security tools by utilizing **low-level techniques, syscall evasion, and memory manipulation**.

### **References for Further Study:**
- **MITRE ATT&CK â€“ Defense Evasion Techniques (T1055, T1202, T1562.001)**
- **Windows Internals (Process & Memory Management)**
- **Advanced Malware Analysis & Evasion Techniques**
- **Red Team Research on AV/EDR Evasion & Memory Manipulation**
- **SpecterOps & Endgame Research on Hooking & Detection Bypass**

---

# **ðŸ›  Step 3: AV & EDR Bypasses (T1055, T1202, T1562.001)**
**Objective:** Defeat modern security solutions using **low-level memory manipulation and anti-detection techniques**.

## **3.1 Evasion of Memory Scanners**

### **Manually Unhooking EDR Hooks (Restoring Original Syscalls via Fresh DLL Mappings)**
- **Why?** Many AV/EDR solutions hook `ntdll.dll` and `kernel32.dll` functions to monitor suspicious behavior.
- **Techniques:**
  - **Manually reload a fresh copy of `ntdll.dll` from disk to remove hooks.**
  - **Use `LdrLoadDll` instead of `LoadLibrary` to prevent detection by API monitoring.**
  - **Resolve functions dynamically to avoid static analysis detection.**
- **Alternative Methods:**
  - **Patch `NtProtectVirtualMemory` to modify memory protections before shellcode execution.**
  - **Use direct syscalls instead of API calls to avoid user-mode hooks.**
  - **Spoof call stack origins to make execution appear legitimate.**

### **Sleep Obfuscation & Timing Attacks (Avoiding Sandboxes and Memory Scanning)**
- **Why?** Sandboxes analyze behavior in a virtualized environment by monitoring execution over a short duration.
- **Techniques:**
  - **Implement `Sleep()` evasion with random delays and hardware-based timers (`QueryPerformanceCounter`).**
  - **Use `SetThreadExecutionState(ES_CONTINUOUS)` to keep processes running even when system activity is low.**
  - **Employ CPU usage-based execution triggers (`RDTSC` instruction to measure CPU cycles).**
- **Alternative Methods:**
  - **Detect sandboxed environments by checking execution speed (delays in a virtualized setting are longer).**
  - **Query system uptime (`GetTickCount()`) and compare with expected values for a real machine.**
  - **Execute payloads in a staged manner over a period to avoid rapid behavioral analysis.**

### **APC Injection & Thread Hijacking (Hiding Execution Within Suspended Threads)**
- **Why?** EDR tools monitor process and thread creation, so traditional injection methods raise alerts.
- **Techniques:**
  - **Queue a user-mode asynchronous procedure call (APC) into a legitimate process.**
  - **Hijack a suspended threadâ€™s execution to execute shellcode in-memory.**
  - **Create remote threads in legitimate Windows processes and modify execution flow.**
- **Alternative Methods:**
  - **Use Early Bird APC Injection (injecting payloads before a process starts execution).**
  - **Employ Thread Stack Spoofing (hiding execution traces from memory scanners).**
  - **Abuse `NtQueueApcThread` to execute payloads without spawning new processes.**

---

## **3.2 Avoiding User-Mode Hooking**

### **Direct Syscalls Instead of WinAPI Calls (SysWhispers, Inline Assembly)**
- **Why?** Many EDRs hook Windows API functions like `CreateRemoteThread`, `VirtualAlloc`, and `NtWriteVirtualMemory`.
- **Techniques:**
  - **Use `SysWhispers` to execute syscalls directly, avoiding API monitoring.**
  - **Invoke system calls with inline assembly (`asm` blocks in C, Rust, or Golang).**
  - **Manually resolve syscall addresses from the System Service Descriptor Table (SSDT).**
- **Alternative Methods:**
  - **Use `Heavenâ€™s Gate` (executing 64-bit syscalls from a 32-bit process).**
  - **Employ indirect syscall execution via function pointers.**
  - **Trigger syscalls from kernel callback functions to blend in with legitimate system activity.**

### **AMSI & ETW Bypass Techniques (Patching `amsi.dll` & ETW Tracing Hooks)**
- **Why?** Windows Defender uses AMSI (Anti-Malware Scan Interface) to scan in-memory scripts and ETW (Event Tracing for Windows) to log security events.
- **Techniques:**
  - **Patch `amsi.dll` in-memory to disable AMSI scanning (`AmsiScanBuffer` patching).**
  - **Hook `NtTraceEvent` to block ETW logging and event collection.**
  - **Use indirect execution methods (`Invoke-Obfuscation`, dynamic PowerShell execution).**
- **Alternative Methods:**
  - **Modify AMSI-related registry keys (`HKLM\SOFTWARE\Microsoft\AMSI`) to disable scanning.**
  - **Execute scripts via `msbuild.exe` to bypass PowerShell script execution restrictions.**
  - **Deploy encrypted shellcode within legitimate system processes to avoid script-based detection.**

### **Code Injection via Hardware Breakpoints (Using Debug Registers to Trigger Payloads)**
- **Why?** Hardware breakpoints can be used to modify execution flow while evading memory scanners.
- **Techniques:**
  - **Use `Dr0-Dr7` debug registers to trigger execution when accessing specific memory regions.**
  - **Modify page protections dynamically (`NtProtectVirtualMemory`) to avoid static detection.**
  - **Abuse `RDTSC` (Time Stamp Counter) to detect hypervisor-based monitoring.**
- **Alternative Methods:**
  - **Use `Process Hollowing` combined with hardware breakpoints to delay execution.**
  - **Hijack legitimate processes (`dllhost.exe`, `rundll32.exe`) and manipulate their execution using breakpoints.**
  - **Implement time-delayed breakpoints to execute payloads only when certain conditions are met.**

---

## **ðŸ“Œ Summary of AV & EDR Bypass Techniques**

| **Stage** | **Primary Method** | **Alternative Methods** |
|---|---|---|
| **Memory Scanner Evasion** | Unhooking EDR Hooks, DLL Remapping | Stack Spoofing, RWX Memory Encryption |
| **Sandbox Evasion** | Sleep Obfuscation, Timing Attacks | Delayed Execution, Hardware Timers |
| **Process Injection** | APC Injection, Thread Hijacking | Early Bird Injection, Phantom DLL Injection |
| **Hook Evasion** | SysWhispers (Direct Syscalls) | Heavenâ€™s Gate, Indirect Function Resolution |
| **AMSI & ETW Bypass** | AMSI Patching, ETW Hooking | Registry Modifications, Dynamic Script Execution |
| **Execution Hijacking** | Hardware Breakpoints | Process Hollowing, Debug Register Manipulation |
